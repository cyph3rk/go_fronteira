# Como configurar envs (RATE_RPS, RATE_BURST, etc.)

Você configura tudo via variáveis de ambiente antes de rodar o gateway (ou via ```docker compose```).

O “mínimo” para o gateway funcionar é:

* ```UPSTREAM_URL``` (obrigatória): para onde o proxy vai encaminhar
* ```LISTEN_ADDR```  (opcional): onde o gateway escuta (default ```:8080```)

Exemplo básico:

``` sh
UPSTREAM_URL="http://localhost:8081" LISTEN_ADDR=":8080" go run ./cmd/gateway
```

## Rate limit (RPS/Burst)

* ```RATE_ENABLED``` (default ```true```): liga/desliga rate limit.
* ```RATE_RPS``` (default ```10```): tokens por segundo (req/s por chave). Aceita float (ex: ```0.5```, ```0.02```).
* ```RATE_BURST``` (default 20): “rajada” inicial (capacidade do balde). Quanto maior, mais requisições iniciais passam.
* ```RATE_KEY_HEADER``` (opcional): se setar, a chave do rate limit vira o valor desse header (ex: ```X-Api-Key```).
* ```TRUST_XFF``` (default ```false```): se ```true```, usa ```X-Forwarded-For``` pra pegar o IP real (útil atrás de LB/reverse proxy).
* ```RETRY_AFTER``` (default 1s): valor do Retry-After quando bloquear (formato Go duration: ```200ms```, ```1s```, ```2s```…).
* ```ADD_RATELIMIT_HEADERS``` (default ```false```): adiciona headers de debug (```X-RateLimit-Key```, ```X-RateLimit-RPS```, ```X-RateLimit-Burst```).

Exemplo “bem agressivo” (1 request e depois 429 por um tempo):

``` sh
UPSTREAM_URL="http://localhost:8081" LISTEN_ADDR=":8080" RATE_RPS=0.02 RATE_BURST=1 go run ./cmd/gateway
```

## Concorrência

* ```CONCURRENCY_MAX``` (default ```100```): máximo de requisições simultâneas.
* ```CONCURRENCY_TIMEOUT``` (default ```0```): quanto tempo esperar vaga (Go duration).
    * ```0``` = espera indefinidamente (até o cliente cancelar)
    * ```200ms``` = se não conseguir vaga em 200ms, retorna erro

Exemplo (no máximo 2 simultâneas, espera no máximo 100ms):

``` sh
CONCURRENCY_MAX=2 CONCURRENCY_TIMEOUT=100ms
```

## Comando completo de exemplo

``` sg
UPSTREAM_URL="http://localhost:8081" LISTEN_ADDR=":8080" RATE_ENABLED=true RATE_RPS=5 RATE_BURST=10 CONCURRENCY_MAX=20 CONCURRENCY_TIMEOUT=0 go run ./cmd/gateway
```

/// Se você me disser o seu cenário (por IP? por API key? atrás de proxy?), 
    eu te sugiro um conjunto de envs “bom” e como testar com curl.